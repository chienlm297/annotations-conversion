name: Docs
on:
  push:
    branches:
      - main

jobs:
  notebooks:
    name: "Build the docs"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Install pandoc
        uses: r-lib/actions/setup-pandoc@v1
        with:
          pandoc-version: "2.7.3" # The pandoc version to download (if necessary) and use.

      - name: Build docs
        run: |
          pip3 install -U pip
          pip3 install -r .github/workflows/requirements.txt
          python3 setup.py develop
          git clean -fdx
          sphinx-apidoc -o docs/source annos_conversion --follow-links
          sphinx-build docs/source out
          rm .git/index
          git add out
          git clean -fdx
          cd out && mv * ../
          cd ..

      - name: Setup deploy options
        id: setup
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if [[ ${GITHUB_REF} = refs/pull/*/merge ]]; then # pull request
            echo "::set-output name=SRC_BRANCH::${GITHUB_HEAD_REF}"
            echo "::set-output name=NO_PUSH::--no-push"
          elif [[ ${GITHUB_REF} = refs/heads/* ]]; then # branch, e.g. master, source etc
            echo "::set-output name=SRC_BRANCH::${GITHUB_REF#refs/heads/}"
          fi
          echo "::set-output name=DEPLOY_BRANCH::gh-pages"

      - name: Deploy website
        run: |
          git checkout -b gh-pages
          git add -fA
          git commit --allow-empty -m "$(git log -1 --pretty=%B) [ci skip]"
          git push -f -q origin gh-pages
